\smalltitle{سوال 2}
\begin{enumerate}
    \item $\text{مشتری} \div \Pi_{\text{شهر ، خیابان}}(\sigma_{\text{نام مشتری} = \text{رضا}}(\text{مشتری}))$
    \item $\Pi_{\text{وام گیرنده}}(\text{وام} \div \rho_{\text{شعب}(\text{شعبه وام دهنده})} (\Pi_{\text{نام شعبه}}(\text{شعبه})))$
    \item در ابتدا قسمت دوم سوال را در می‌آوریم. یعنی نام و نام شهر مشتریانی که در همه‌ی شعب تهران حساب دارند.
    برای این کار در ابتدا لیست تمامی شعب تهران را پیدا می‌کنیم و بر لیست افراد و شعبه بانکی تقسیم می‌کنیم.
    برای این کار از رابطه‌های زیر استفاده می‌کنیم:
    \begin{gather*}
        \text{CustomerAccountPlaces} := \Pi_{\text{نام مشتری، شهر مشتری، شهر شعبه}}(
        \\
        (\rho_{\text{شعبه}(\text{نام شعبه، شهر شعبه})}\text{شعبه})
        \\
        \bowtie_{\text{شعبه افتتاح کننده}=\text{نام شعبه}}
        \\
        (\text{حساب}
        \\
        \bowtie_{\text{نام مشتری}=\text{نام صاحب حساب}}
        \\(\rho_{\text{مشتری}(\text{نام مشتری، شهر مشتری})}(\Pi_{\text{نام مشتری، شهر}}(\text{مشتری})))))
        \\
        A := \text{CustomerAccountPlaces} \div \Pi_{\text{شهر شعبه}}(\rho_{\text{شعب}(\text{نام شعبه، شهر شعبه})}(\sigma_{\text{شهر}=\text{تهران}}\text{شعبه}))
    \end{gather*}
    بعد از انجام رابطه بالا،
    $A$
    شامل دو ستون نام مشتری و شهر مشتری است که حاوی مشتریانی است که در همه‌ی شعب در تهران حساب دارند.
    حال برای حساب کردن قسمت اول سوال بدین صورت عمل می‌کنیم؛ در ابتدا با سه
    \lr{join}
    مثل قسمت قبل جدولی می‌سازیم که نام و شهر مشتری و شهر شعبه‌ای که از آن وام گرفته باشد در آن موجود باشد.
    سپس آن مشتریانی را انتخاب می‌کنیم که شهر خودشان با شهر شعبه‌ای که وام گرفته‌اند از آن فرق کند.
    \begin{gather*}
        \text{CustomerLoanPlaces} := \Pi_{\text{نام مشتری، شهر مشتری، شهر شعبه}}(
        \\
        (\rho_{\text{شعبه}(\text{نام شعبه، شهر شعبه})}\text{شعبه})
        \\
        \bowtie_{\text{شعبه وام دهنده}=\text{نام شعبه}}
        \\
        (\text{وام}
        \\
        \bowtie_{\text{نام مشتری}=\text{وام گیرنده}}
        \\(\rho_{\text{مشتری}(\text{نام مشتری، شهر مشتری})}(\Pi_{\text{نام مشتری، شهر}}(\text{مشتری})))))
        \\
        B := \Pi_\text{نام مشتری، شهر مشتری} \rho_{\text{شهر شعبه} != \text{شهر مشتری}} \text{CustomerLoanPlaces}
    \end{gather*}
    در نهایت $A$ و $B$ را اشتراک می‌گیریم.
    \begin{gather*}
        A \cap B
    \end{gather*}
    اما به نظر می‌رسید که باید
    $B$
    را چیزی دیگری در نظر می‌گرفتیم:
    کسانی که در تمام شهر‌های دیگر غیر از شهر خودشان وام دارند. برای حل این مسئله و بدست آوردن
    $B$
    بدین صورت عمل می‌کنیم. در ابتدا افرادی را پیدا می‌کنیم که در تمام شهر‌ها غیر از یکی وام داشته باشند.
    برای این کار مشتری و وام و شعبه را جوین می‌دهیم. سپس جدولی از مشتری و شهری که از آن وام گرفته‌است تهیه می‌کنیم.
    سپس بر روی این لیست یک
    \lr{count}
    بر اساس اسم می‌زنیم. این جدول به ما نشان می‌دهد که هر نفر از چند شهر وام گرفته است.
    برای سادگی من از
    \lr{natural join}
    استفاده می‌کنم که رابطه کوتاه‌تر شود.
    \begin{gather*}
        \text{LoanCityCount} := \text{نام مشتری} \mathcal{G}_{\operatorname{count}(*)} (\Pi_{\text{نام مشتری، شهر شعبه}} (\text{مشتری} \infty \text{وام} \infty \text{شعبه}))
    \end{gather*}
    حال تعداد شهر‌ها را بدست می‌آوریم در جدول فوق ضرب دکارتی می‌کنیم. با این کار به تمامی
    \lr{tuple}ها
    تعداد شهر‌ها را نیز اضافه می‌کنیم. در نهایت نیز
    \lr{tuple}هایی
    را انتخاب می‌کنیم که
    \lr{count}
    آنها یکی از تعداد شهر‌ها کمتر باشد.
    \begin{gather*}
        \text{WithoutLoanOfOneCity} := \Pi_{\text{نام مشتری}} (\sigma_{\text{total} - 1 == \text{count}} (\text{LoanCityCount} \times \mathcal{G}_{\operatorname{count}(\text{شهر})} \text{شعبه}))
    \end{gather*}
    حال از بین این مشتری‌ها آنهایی را انتخاب می‌کنیم که در شهر خود وام ندارند و این جواب مسئله ما است. دلیل
    این موضوع این است می‌دانیم که این افراد تنها از یک شهر وام نگرفته‌اند که در این حالت یعنی از کل شهر‌ها
    غیر از شهر خود وام گرفته‌اند. برای بدست اوردن این مورد نیز از متمم آن استفاده می‌کنیم. یعنی افرادی را بدست
    می‌آوریم که از شهر خود وام گرفته اند و آنها را حذف می‌کنیم از لیست.
    \begin{gather*}
        \Pi_{\text{نام مشتری}, \text{شهر مشتری}} \text{مشتری}
        \\
        -
        \\
        \Pi_{\text{نام مشتری}, \text{شهر مشتری}} (\sigma_{\text{شهر مشتری} == \text{شهر شعبه}} ((\text{مشتری} \ltimes \text{WithoutLoanOfOneCity}) \infty \text{وام} \infty \text{شعبه}))
    \end{gather*}
    \item در ابتدا لیست همشهری‌های مجید را پیدا می‌کنیم. برای اینکار در ابتدا شهر مجید را پیدا می‌کنیم. خروجی
    مورد نظر یک جدول است که یک ستون و یک سطر دارد. سپس این جدول را با خود مشتری‌ها
    \lr{join}
    می‌دهیم. با این کار اسامی افرادی در می‌آید که همشهری مجید هستند و خود مجید در می‌آید. معلوم نیست که در سوال
    لازم است که خود مجید را همشهری مجید بگیریم یا خیر. در صورتی که خود مجید مد نظر نیست، کافی است که از
    $-\{\text{مجید}\}$
    استفاده کنیم در آخر رابطه زیر:
    \begin{gather*}
        \text{MajidFellowCitizen} := \Pi_{\text{نام مشتری}} (\text{مشتری} \infty (\Pi{\text{شهر}}(\sigma_{\text{نام مشتری}=\text{مجید}}\text{مشتری})))
    \end{gather*}
    حال می‌خواهیم لیست شعبی را انتخاب کنیم که به این مشتری‌ها وام داده‌اند. برای این کار، لیست مشتریان را
    با لیست وام‌ها
    \lr{join}
    می‌دهیم.
    \begin{gather*}
        \text{BanksLoanToMajidFellowCitizen} := \Pi_{\text{نام شعبه}}(\text{MajidFellowCitizen} \bowtie_{\text{نام مشتری}=\text{وام گیرنده}} \text{وام})
    \end{gather*}
    حال باید لیست شعبه‌هایی را پیدا کنیم که هیچ کدام از همشهری‌های رضا در آن حساب ندارند. در ابتدا مثل قسمت
    اول لیست همشهری‌های رضا را پیدا می‌کنیم. سپس لیست شعبه‌هایی را پیدا می‌کنیم که همشهری‌های رضا در آن حساب
    \underline{دارند}.
    در نهایت تمام شعب را منهای جدول بدست آمده می‌کنیم.
    \begin{gather*}
        \text{RezaFellowCitizen} := \Pi_{\text{نام مشتری}} (\text{مشتری} \infty (\Pi{\text{شهر}}(\rho_{\text{نام مشتری}=\text{رضا}}\text{مشتری})))
        \\
        \text{BanksWithAccountsOfRezaFellowCitizens} :=\\ \Pi_{\text{نام شعبه}}(\text{RezaFellowCitizen} \bowtie_{\text{نام مشتری}=\text{نام صاحب حساب}} \text{حساب})
        \\
        \text{BanksWithoutAccountsOfRezaFellowCitizens} :=\\ \Pi_{\text{نام شعبه}} \text{شعبه} - \text{BanksWithAccountsOfRezaFellowCitizens}
    \end{gather*}
    در نهایت دو مقدار حاصل را از هم کم می‌کنیم.
    \begin{gather*}
        \text{BanksLoanToMajidFellowCitizen} - \text{BanksWithoutAccountsOfRezaFellowCitizens}
    \end{gather*}
\end{enumerate}
